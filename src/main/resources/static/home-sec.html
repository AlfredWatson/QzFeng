<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>用户调查问卷</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4 mb-5">
    <h2 class="text-center mb-4">用户调查问卷</h2>
    <form id="surveyForm" enctype="multipart/form-data">

        <!-- 蜂胶使用情况 -->
        <h5 class="mt-4 mb-3">蜂胶使用情况</h5>
        <div class="mb-3">
            <label class="form-label">1. 您是否服用过蜂胶</label>
            <select class="form-select conditional-select" id="propolis" name="propolis" data-target="propolisDetails" required>
                <option value="">请选择</option>
                <option value="false">否 (0)</option>
                <option value="true">是 (1)</option>
            </select>
        </div>
        <div id="propolisDetails" class="conditional-details d-none">
            <div class="mb-3">
                <label class="form-label">2. 您开始服用蜂胶的年份</label>
                <select class="form-select" id="propolisYear" name="propolisYear">
                    <option value="">请选择年份</option>
                    <!-- 用JS动态生成年份 -->
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">3. 您通常服用蜂胶的频率</label>
                <select class="form-select" id="propolisFrequency" name="propolisFrequency">
                    <option value="">请选择</option>
                    <option value="A">A. 频繁服用，每周 >4 次</option>
                    <option value="B">B. 经常服用，每周 1-3 次</option>
                    <option value="C">C. 偶尔服用，每周 1 次</option>
                    <option value="D">D. 以前未服用</option>
                </select>
            </div>
        </div>

        <!-- 四、主观评估 -->
        <h5 class="mt-4 mb-3">主观评估</h5>
        <p class="text-muted">每项请选择评分：0=无效, 1=有效, 2=不详</p>
        <div class="mb-3">
            <label class="form-label">1. 感冒较以往次数减少</label>
            <select class="form-select evaluation-item" required>
                <option value="">请选择</option>
                <option value="0">0 - 无效</option>
                <option value="1">1 - 有效</option>
                <option value="2">2 - 不详</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">2. 睡眠质量改善</label>
            <select class="form-select evaluation-item" required>
                <option value="">请选择</option>
                <option value="0">0 - 无效</option>
                <option value="1">1 - 有效</option>
                <option value="2">2 - 不详</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">3. 胃肠道功能改善</label>
            <select class="form-select evaluation-item" required>
                <option value="">请选择</option>
                <option value="0">0 - 无效</option>
                <option value="1">1 - 有效</option>
                <option value="2">2 - 不详</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">4. 身体疲乏感减轻</label>
            <select class="form-select evaluation-item" required>
                <option value="">请选择</option>
                <option value="0">0 - 无效</option>
                <option value="1">1 - 有效</option>
                <option value="2">2 - 不详</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">5. 口腔溃疡次数减少</label>
            <select class="form-select evaluation-item" required>
                <option value="">请选择</option>
                <option value="0">0 - 无效</option>
                <option value="1">1 - 有效</option>
                <option value="2">2 - 不详</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">6. 改善咽喉部不适感</label>
            <select class="form-select evaluation-item" required>
                <option value="">请选择</option>
                <option value="0">0 - 无效</option>
                <option value="1">1 - 有效</option>
                <option value="2">2 - 不详</option>
            </select>
        </div>
        <!-- 隐藏字段 -->
        <input type="hidden" id="evaluation" name="evaluation">

        <!--五、体检单-->
        <h5 class="mt-4 mb-3">体检单</h5>
        <div class="mb-3">
            <label class="form-label">上传体检报告</label>
            <input class="form-control" type="file" id="picFile" name="picFile" accept="image/*">
            <input type="hidden" id="picUrl" name="picUrl">
            <div id="preview" class="mt-3"></div>
        </div>

        <button type="submit" class="btn btn-primary w-100">提交</button>
    </form>
</div>

<script src="./js/bootstrap.bundle.min.js"></script>
<script>
    const token = localStorage.getItem('Authorization');

    // 动态生成年份（1980~今年）
    const yearSelect = document.getElementById('propolisYear');
    const currentYear = new Date().getFullYear();
    for (let y = currentYear; y >= 1980; y--) {
        yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
    }

    // 动态显示/隐藏病程和服药
    document.querySelectorAll('.conditional-select').forEach(select => {
        select.addEventListener('change', function () {
            const details = document.getElementById(this.dataset.target);
            if (this.value === "true") {
                details.classList.remove('d-none');
            } else {
                details.classList.add('d-none');
                // 清空隐藏区域的值
                details.querySelectorAll('input, select').forEach(input => input.value = '');
            }
        });
    });

    document.getElementById('picFile').addEventListener('change', function () {
        const file = this.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        fetch('/user/checkup/uploads', {
            method: 'POST',
            headers: {
                'Authorization': token
            },
            body: formData
        })
            .then(response => response.json())
            .then(result => {
                console.log(result);
                if (result.code === 1) {
                    // 保存返回的picUrl到隐藏字段
                    document.getElementById('picUrl').value = result.data.picUrl;
                    // alert("图片上传成功");
                    console.log(result.data.picUrl)
                } else {
                    alert("图片上传失败: " + result.msg);
                }
            })
            .catch(err => {
                console.error(err);
                alert("上传图片出错，请重试");
            });
    });

    document.getElementById('surveyForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // 合并六项主观评估
        const evalItems = document.querySelectorAll('.evaluation-item');
        const evalValues = [];
        let hasEmpty = false;

        // // 若未上传图片，确保picUrl为空字符串
        // if (!$('#picUrl').val()) {
        //     $('#picUrl').val('');
        // }

        evalItems.forEach(select => {
            if (!select.value) hasEmpty = true;
            evalValues.push(select.value);
        });
        if (hasEmpty) {
            alert('请完成所有主观评估项');
            return;
        }
        document.getElementById('evaluation').value = evalValues.join(',');

        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
            if (value === "true") value = true;
            if (value === "false") value = false;
            data[key] = value;
        });

        console.log(data);

        fetch('/user/all/saveQuestionnaires', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.code === 1) {
                    alert("提交成功，谢谢");
                    // window.location.href = "/static/login.html";
                    this.reset();
                    $('#preview').empty();
                    $('#propolisDetails').hide();
                } else {
                    alert("提交失败：" + result.msg);
                }
            })
            .catch(err => {
                console.error(err);
                // alert("提交异常，请稍后重试");
            });
    });
</script>
</body>
</html>
